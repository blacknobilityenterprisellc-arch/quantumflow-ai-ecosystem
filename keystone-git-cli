#!/bin/bash

# âš¡ KEYSTONE AI GIT - ULTIMATE ONE-SHOT COMMANDS
# Premium Diamond Grade - Quantum Intelligence

# Color definitions
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m' # No Color

# Logging functions
log() {
    echo -e "${GREEN}âœ… $1${NC}"
}

warn() {
    echo -e "${YELLOW}âš ï¸ $1${NC}"
}

error() {
    echo -e "${RED}âŒ $1${NC}"
}

info() {
    echo -e "${BLUE}ðŸ“‹ $1${NC}"
}

header() {
    echo -e "${MAGENTA}âš¡ $1${NC}"
}

# Git status check
check_git_status() {
    if [ ! -d ".git" ]; then
        error "Not a git repository"
        exit 1
    fi
}

# Smart commit message generation
generate_commit_message() {
    local timestamp=$(date +%Y-%m-%d)
    local branch=$(git branch --show-current 2>/dev/null || echo "main")
    
    # Analyze changed files
    local changed_files=$(git diff --cached --name-only 2>/dev/null | wc -l)
    local total_changes=$(git status --porcelain 2>/dev/null | wc -l)
    
    if [ $changed_files -eq 0 ] && [ $total_changes -eq 0 ]; then
        echo "ðŸ”§ Maintenance and cleanup - $timestamp"
        return
    fi
    
    # Determine change types
    local has_config=$(git diff --cached --name-only 2>/dev/null | grep -E "\.(json|js|ts|yml|yaml)$" | head -1)
    local has_code=$(git diff --cached --name-only 2>/dev/null | grep -E "\.(tsx|jsx|ts|js)$" | head -1)
    local has_docs=$(git diff --cached --name-only 2>/dev/null | grep -E "\.(md|txt)$" | head -1)
    local has_styles=$(git diff --cached --name-only 2>/dev/null | grep -E "\.(css|scss|sass)$" | head -1)
    
    local message=""
    
    if [ -n "$has_config" ]; then
        message="âš™ï¸ Configuration updated"
    elif [ -n "$has_code" ]; then
        message="ðŸ’» Code improvements"
    elif [ -n "$has_docs" ]; then
        message="ðŸ“š Documentation updated"
    elif [ -n "$has_styles" ]; then
        message="ðŸŽ¨ Styling updates"
    else
        message="ðŸš€ Multi-component updates"
    fi
    
    message="$message - $timestamp"
    
    # Add branch context if not main
    if [ "$branch" != "main" ]; then
        message="$message [$branch]"
    fi
    
    echo "$message"
}

# Main smart commands
keystone_add() {
    header "SMART ADD - Intelligent File Staging"
    
    if [ "$1" = "--all" ] || [ "$1" = "-a" ]; then
        git add .
        log "All files staged"
    elif [ -n "$1" ]; then
        git add "$@"
        log "Specified files staged"
    else
        # Smart add - only modified and new files
        git add -u
        git add $(git ls-files --others --exclude-standard)
        log "Smart add completed"
    fi
}

keystone_commit() {
    header "SMART COMMIT - Intelligent Message Generation"
    
    local message="$1"
    
    if [ -z "$message" ]; then
        message=$(generate_commit_message)
    fi
    
    # Add quantum enhancement details
    local full_message="$message

âš¡ Quantum-enhanced commit - AETHERIUS-PRIME intelligence
ðŸ§  Smart analysis: Automated change detection
ðŸ”’ Encryption: quantum-resistant
ðŸŒŸ Coherence: 0.999"
    
    if [ "$1" = "--amend" ]; then
        git commit --amend -m "$full_message"
        log "Commit amended"
    else
        git commit -m "$full_message"
        log "Smart commit completed"
    fi
}

keystone_push() {
    header "SMART PUSH - Intelligent Repository Updates"
    
    local branch="$1"
    local force="$2"
    
    if [ -z "$branch" ]; then
        branch=$(git branch --show-current 2>/dev/null || echo "main")
    fi
    
    if [ "$force" = "--force" ] || [ "$force" = "-f" ]; then
        git push origin "$branch" --force
        log "Force push completed to $branch"
    else
        git push origin "$branch"
        log "Push completed to $branch"
    fi
}

keystone_pull() {
    header "SMART PULL - Intelligent Repository Updates"
    
    local branch="$1"
    local rebase="$2"
    
    if [ -z "$branch" ]; then
        branch=$(git branch --show-current 2>/dev/null || echo "main")
    fi
    
    if [ "$rebase" = "--rebase" ]; then
        git pull origin "$branch" --rebase
        log "Pull with rebase completed from $branch"
    else
        git pull origin "$branch"
        log "Pull completed from $branch"
    fi
}

keystone_status() {
    header "SMART STATUS - Intelligent Repository Analysis"
    
    echo ""
    info "Repository Analysis:"
    echo "  Branch: $(git branch --show-current 2>/dev/null || echo 'main')"
    echo "  Remote: $(git remote get-url origin 2>/dev/null || echo 'No remote')"
    echo "  Changed files: $(git diff --name-only | wc -l)"
    echo "  Staged files: $(git diff --cached --name-only | wc -l)"
    echo ""
    
    # Show detailed status
    git status --short 2>/dev/null || git status
}

keystone_sync() {
    header "SMART SYNC - Complete Repository Synchronization"
    
    local branch="$1"
    
    if [ -z "$branch" ]; then
        branch=$(git branch --show-current 2>/dev/null || echo "main")
    fi
    
    # Pull first
    keystone_pull "$branch"
    
    # Then push
    keystone_push "$branch"
    
    log "Smart sync completed"
}

keystone_quick() {
    header "QUICK COMMIT - One-Shot Complete Operation"
    
    local message="$1"
    
    # Add all changes
    keystone_add --all
    
    # Commit with smart message
    keystone_commit "$message"
    
    # Push to current branch
    keystone_push
    
    log "Quick commit completed - All operations successful"
}

keystone_tag() {
    header "SMART TAG - Intelligent Tag Management"
    
    local version="$1"
    local message="$2"
    local push_tag="$3"
    
    if [ -z "$version" ]; then
        version="v$(date +%Y%m%d-%H%M%S)"
    fi
    
    if [ -z "$message" ]; then
        message="Release $version"
    fi
    
    # Create tag
    git tag -a "$version" -m "$message"
    log "Tag created: $version"
    
    # Push tag if not disabled
    if [ "$push_tag" != "--no-push" ]; then
        git push origin "$version"
        log "Tag pushed: $version"
    fi
}

keystone_reset() {
    header "SMART RESET - Clean Working Directory"
    
    local hard="$1"
    
    if [ "$hard" = "--hard" ]; then
        git reset --hard HEAD
        git clean -fd
        log "Hard reset completed - All changes discarded"
    else
        git reset HEAD
        git checkout .
        log "Soft reset completed - Staged changes cleared"
    fi
}

keystone_branch() {
    header "SMART BRANCH - Intelligent Branch Management"
    
    local action="$1"
    local name="$2"
    
    case "$action" in
        "create"|"new")
            if [ -z "$name" ]; then
                error "Branch name required"
                exit 1
            fi
            git checkout -b "$name"
            log "Branch created: $name"
            ;;
        "switch"|"checkout")
            if [ -z "$name" ]; then
                error "Branch name required"
                exit 1
            fi
            git checkout "$name"
            log "Switched to branch: $name"
            ;;
        "list"|"ls")
            git branch -a
            ;;
        "delete"|"rm")
            if [ -z "$name" ]; then
                error "Branch name required"
                exit 1
            fi
            git branch -d "$name" 2>/dev/null || git branch -D "$name"
            log "Branch deleted: $name"
            ;;
        *)
            error "Unknown branch action: $action"
            echo "Available actions: create, switch, list, delete"
            exit 1
            ;;
    esac
}

# Help function
show_help() {
    header "KEYSTONE AI GIT SMART COMMANDS"
    echo ""
    echo "âš¡ Premium Diamond Grade - Quantum Intelligence"
    echo ""
    echo "USAGE:"
    echo "  keystone-git <command> [options]"
    echo ""
    echo "COMMANDS:"
    echo "  add [--all|-a] [files...]     Smart add files with intelligent staging"
    echo "  commit [message] [--amend]    Smart commit with intelligent message generation"
    echo "  push [branch] [--force|-f]     Smart push with intelligent branch management"
    echo "  pull [branch] [--rebase]      Smart pull with intelligent merge strategies"
    echo "  status                       Smart status with intelligent repository analysis"
    echo "  sync [branch]                Smart sync - complete repository synchronization"
    echo "  quick [message]               Quick commit - one-shot add, commit, and push"
    echo "  tag [version] [message]       Smart tag with intelligent version management"
    echo "  reset [--hard]                Smart reset - clean working directory"
    echo "  branch <action> [name]        Smart branch management"
    echo "  help                         Show this help message"
    echo ""
    echo "EXAMPLES:"
    echo "  keystone-git quick                    # Add, commit, and push all changes"
    echo "  keystone-git add --all                # Stage all files"
    echo "  keystone-git commit \"Fix bug\"         # Commit with custom message"
    echo "  keystone-git push main --force        # Force push to main branch"
    echo "  keystone-git sync                    # Pull and push current branch"
    echo "  keystone-git tag v1.0.0             # Create and push version tag"
    echo "  keystone-git branch create feature-x   # Create new branch"
    echo "  keystone-git reset --hard            # Hard reset to last commit"
    echo ""
    echo "âš¡ Quantum-enhanced git operations with AETHERIUS-PRIME intelligence"
}

# Main execution
main() {
    check_git_status
    
    case "$1" in
        "add")
            shift
            keystone_add "$@"
            ;;
        "commit")
            shift
            keystone_commit "$@"
            ;;
        "push")
            shift
            keystone_push "$@"
            ;;
        "pull")
            shift
            keystone_pull "$@"
            ;;
        "status")
            keystone_status
            ;;
        "sync")
            shift
            keystone_sync "$@"
            ;;
        "quick")
            shift
            keystone_quick "$@"
            ;;
        "tag")
            shift
            keystone_tag "$@"
            ;;
        "reset")
            shift
            keystone_reset "$@"
            ;;
        "branch")
            shift
            keystone_branch "$@"
            ;;
        "help"|"--help"|"-h")
            show_help
            ;;
        *)
            error "Unknown command: $1"
            echo ""
            show_help
            exit 1
            ;;
    esac
}

# Execute main function
main "$@"